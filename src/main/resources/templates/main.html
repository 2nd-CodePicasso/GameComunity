<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì„ ì»¤ë®¤ë‹ˆí‹° - ë©”ì¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* ê³µí†µ ìŠ¤íƒ€ì¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ë°ìŠ¤í¬íƒ‘ ì»¨í…Œì´ë„ˆ */
        .desktop-container {
            width: 100%;
            max-width: 1200px;
            margin: 40px auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            position: relative;
        }

        /* ë°ìŠ¤í¬íƒ‘ í—¤ë” */
        .desktop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background-color: #4263eb;
            color: white;
        }

        .desktop-logo {
            font-size: 24px;
            font-weight: 700;
        }

        .desktop-nav {
            display: flex;
            gap: 24px;
        }

        .desktop-nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .desktop-nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* ë°ìŠ¤í¬íƒ‘ ë ˆì´ì•„ì›ƒ */
        .desktop-layout {
            display: flex;
            gap: 24px;
            padding: 24px;
        }

        .desktop-sidebar {
            width: 280px;
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .desktop-main {
            flex: 1;
        }

        /* ë¡œê·¸ì¸ í¼ ìŠ¤íƒ€ì¼ */
        .login-form {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 24px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .form-title {
            font-size: 18px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4263eb;
            box-shadow: 0 0 0 3px rgba(66, 99, 235, 0.1);
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            width: 100%;
        }

        .btn-primary {
            background-color: #4263eb;
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            color: #495057;
            border: 1px solid #e9ecef;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        /* í˜ì´ì§€ ì„¹ì…˜ ë²„íŠ¼ë“¤ */
        .pages-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .page-button {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .page-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: white;
            font-size: 18px;
        }

        .board-icon {
            background-color: #339af0;
        }

        .item-icon {
            background-color: #20c997;
        }

        .chat-icon {
            background-color: #845ef7;
        }

        .page-title {
            font-weight: 600;
            color: #212529;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .page-description {
            color: #868e96;
            font-size: 13px;
        }

        /* ë°ìŠ¤í¬íƒ‘ ë©”ì¸ ì½˜í…ì¸  */
        .content-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            font-size: 18px;
            color: #212529;
            background-color: #f8f9fa;
        }

        .card-body {
            padding: 24px;
        }

        .popular-content-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .popular-content-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .popular-content-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .news-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-category {
            background-color: #4263eb;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .news-title {
            flex: 1;
            font-size: 15px;
            color: #212529;
        }

        .news-date {
            color: #868e96;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            background-color: #fff5f5;
            border: 1px solid #ffc9c9;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 16px;
            color: #e03131;
            font-size: 14px;
        }

        /* ë§í¬ ìŠ¤íƒ€ì¼ */
        .text-link {
            color: #4263eb;
            text-decoration: none;
            font-size: 14px;
            margin-top: 12px;
            display: inline-block;
        }

        .text-link:hover {
            text-decoration: underline;
        }

        /* ì±„íŒ… ìœ„ì ¯ ìŠ¤íƒ€ì¼ */
        .chat-widgets-group {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .chat-widgets-container {
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin-bottom: 10px;
        }

        .chat-toggle-button {
            width: 60px;
            height: 60px;
            background-color: #4263eb;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .chat-toggle-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        .chat-widget {
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            transform-origin: bottom right;
        }

        .chat-widget.minimized {
            transform: scale(0);
            opacity: 0;
            height: 0;
            margin-bottom: 0;
        }

        .chat-rooms-widget {
            width: 280px;
            height: 500px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            transform: translateX(10px);
            opacity: 0;
            visibility: hidden;
        }

        .chat-rooms-widget.visible {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }

        .chat-header {
            padding: 16px;
            background-color: #4263eb;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .chat-header-title {
            font-weight: 700;
            font-size: 16px;
        }

        .chat-header-room-name {
            font-weight: 700;
            font-size: 16px;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        .chat-action-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .chat-action-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .chat-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chat-rooms-panel {
            padding: 16px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }

        .chat-room-form {
            margin-bottom: 20px;
            border-radius: 8px;
            padding: 16px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .chat-room-form h3 {
            margin-bottom: 12px;
            font-size: 15px;
            color: #212529;
        }

        .chat-form-group {
            margin-bottom: 12px;
        }

        .chat-form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #495057;
        }

        .chat-form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }

        .chat-form-input:focus {
            outline: none;
            border-color: #4263eb;
            box-shadow: 0 0 0 2px rgba(66, 99, 235, 0.1);
        }

        .chat-form-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .chat-form-checkbox input {
            margin-right: 8px;
        }

        .chat-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .chat-btn-primary {
            background-color: #4263eb;
            color: white;
        }

        .chat-btn-primary:hover {
            background-color: #3b5bdb;
        }

        .chat-room-list {
            list-style: none;
            margin-top: 16px;
        }

        .chat-room-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e9ecef;
        }

        .chat-room-item:hover {
            background-color: #e9ecef;
        }

        .chat-room-name {
            font-weight: 500;
            color: #212529;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .chat-room-lock {
            margin-left: 6px;
            font-size: 12px;
            color: #868e96;
        }

        .chat-room-active {
            background-color: #e7f5ff;
            border-color: #4263eb;
        }

        .chat-messages-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-message {
            margin-bottom: 12px;
            max-width: 85%;
        }

        .chat-message-incoming {
            align-self: flex-start;
        }

        .chat-message-outgoing {
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message-content {
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 14px;
            word-break: break-word;
        }

        .chat-message-incoming .chat-message-content {
            background-color: #f1f3f5;
            color: #212529;
            border-top-left-radius: 4px;
        }

        .chat-message-outgoing .chat-message-content {
            background-color: #4263eb;
            color: white;
            border-top-right-radius: 4px;
        }

        .chat-message-info {
            display: flex;
            font-size: 12px;
            color: #868e96;
            margin-top: 4px;
        }

        .chat-message-incoming .chat-message-info {
            justify-content: flex-start;
        }

        .chat-message-outgoing .chat-message-info {
            justify-content: flex-end;
        }

        .chat-message-username {
            font-weight: 500;
            margin-right: 6px;
        }

        .chat-message-time {
            font-size: 11px;
        }

        .chat-input-container {
            padding: 12px;
            border-top: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4263eb;
        }

        .chat-send-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #4263eb;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
        }

        .chat-send-button:hover {
            background-color: #3b5bdb;
        }

        .chat-attach-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #ced4da;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
        }

        .chat-attach-button:hover {
            background-color: #e9ecef;
        }

        .chat-file-input {
            display: none;
        }

        .chat-login-required {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 24px;
            text-align: center;
        }

        .chat-login-icon {
            font-size: 48px;
            color: #ced4da;
            margin-bottom: 16px;
        }

        .chat-login-message {
            color: #495057;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .chat-login-button {
            padding: 8px 16px;
            background-color: #4263eb;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-login-button:hover {
            background-color: #3b5bdb;
        }

        /* ì‘ë‹µ ì‹œê°„ ìŠ¤íƒ€ì¼ */
        .chat-response-time {
            font-size: 11px;
            color: #868e96;
            text-align: center;
            margin: 8px 0;
        }

        /* ë¹„ë°€ë°© ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ */
        .chat-password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .chat-password-modal.visible {
            visibility: visible;
            opacity: 1;
        }

        .chat-password-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 300px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .chat-password-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #212529;
        }

        .chat-password-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }

        .chat-password-button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .chat-password-button-cancel {
            background-color: #e9ecef;
            color: #495057;
        }

        .chat-password-button-submit {
            background-color: #4263eb;
            color: white;
        }
    </style>
</head>
<body>
<!-- ë°ìŠ¤í¬íƒ‘ ì»¨í…Œì´ë„ˆ -->
<div class="desktop-container">
    <!-- ë°ìŠ¤í¬íƒ‘ í—¤ë” -->
    <div class="desktop-header">
        <div class="desktop-logo">ê²Œì„ ì»¤ë®¤ë‹ˆí‹°</div>
        <div class="desktop-nav">
            <a href="/main/hi/game" class="active">í™ˆ</a>
            <a href="/gameboard/hi/game">ê²Œì‹œíŒ</a>
            <a href="/exchange/hi/game">ì•„ì´í…œ ê±°ë˜ì†Œ</a>
            <a href="/chats/hi/lol">ì±„íŒ…ë°©</a>
        </div>
    </div>

    <!-- ë°ìŠ¤í¬íƒ‘ ë ˆì´ì•„ì›ƒ -->
    <div class="desktop-layout">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="desktop-sidebar">
            <!-- ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ ë‚´ìš© í‘œì‹œ -->
            <div id="non-logged-in-content">
                <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ: ë¡œê·¸ì¸ í¼ -->
                <h2 class="form-title">ë¡œê·¸ì¸</h2>

                <div class="form-group">
                    <label for="username" class="form-label">ì•„ì´ë””</label>
                    <input type="text" id="username" name="username" class="form-input" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                           required>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" name="password" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                           required>
                </div>

                <div class="buttons-container">
                    <button type="submit" class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
                    <a href="/signup/hi/game" class="btn btn-outline">íšŒì›ê°€ì…</a>
                </div>

                <div style="text-align: center; margin-top: 16px;">
                    <a href="#" class="text-link">ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
                </div>
            </div>

            <!-- ë¡œê·¸ì¸í•œ ê²½ìš°: íšŒì› ì •ë³´ -->
            <div id="logged-in-content" style="display: none;" class="user-info-card">
                <div class="user-info-header">
                    <h2 class="form-title">íšŒì› ì •ë³´</h2>
                </div>

                <div class="user-profile">
                    <div class="profile-image">
                        <!-- ê¸°ë³¸ í”„ë¡œí•„ ì´ë¯¸ì§€ -->
                        <div class="avatar-circle">
                            <span class="avatar-text">G</span>
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="user-nickname" id="user-nickname">ë¡œë”© ì¤‘...</div>
                        <div class="user-id" id="join-date">ë¡œë”© ì¤‘...</div>
                    </div>
                </div>

                <div class="buttons-container">
                    <a href="/users/my-profile" class="btn btn-outline">ë‚´ í”„ë¡œí•„</a>
                    <a href="#" class="btn btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                </div>
            </div>

            <!-- ë°”ë¡œê°€ê¸° ë©”ë‰´ -->
            <div style="margin-top: 24px;">
                <h3 style="margin-bottom: 16px; font-size: 16px; color: #495057;">ë°”ë¡œê°€ê¸°</h3>
                <div class="pages-section">
                    <a href="/gameboard/hi/game" class="page-button">
                        <div class="icon board-icon">B</div>
                        <div>
                            <div class="page-title">ê²Œì‹œíŒ</div>
                        </div>
                    </a>

                    <a href="/exchange/hi/game" class="page-button">
                        <div class="icon item-icon">I</div>
                        <div>
                            <div class="page-title">ì•„ì´í…œ ê±°ë˜ì†Œ</div>
                        </div>
                    </a>

                    <a href="/chats/hi/lol" class="page-button">
                        <div class="icon chat-icon">C</div>
                        <div>
                            <div class="page-title">ì±„íŒ…ë°©</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="desktop-main">
            <!-- ì¸ê¸° ê²Œì„ ì¹´ë“œ -->
            <div class="content-card" id="popular-games-card">
                <div class="card-header">ì¸ê¸° ê²Œì„</div>
                <div class="card-body">
                    <div class="popular-content-grid">
                        <div class="popular-content-item">
                            <h4>ë¦¬ê·¸ ì˜¤ë¸Œ ë ˆì „ë“œ</h4>
                            <p style="color: #868e96; font-size: 14px; margin-top: 8px;">í™œì„± ìœ ì €: 3,542ëª…</p>
                        </div>
                        <div class="popular-content-item">
                            <h4>ë°°í‹€ê·¸ë¼ìš´ë“œ</h4>
                            <p style="color: #868e96; font-size: 14px; margin-top: 8px;">í™œì„± ìœ ì €: 2,901ëª…</p>
                        </div>
                        <div class="popular-content-item">
                            <h4>ì˜¤ë²„ì›Œì¹˜</h4>
                            <p style="color: #868e96; font-size: 14px; margin-top: 8px;">í™œì„± ìœ ì €: 2,158ëª…</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìµœì‹  ì†Œì‹ ì¹´ë“œ -->
            <div class="content-card" id="latest-news-card">
                <div class="card-header">ìµœì‹  ì†Œì‹</div>
                <div class="card-body">
                    <div class="news-item">
                        <span class="news-category">ë¡œë”©ì¤‘</span>
                        <div class="news-title">ë¡œë”©ì¤‘</div>
                        <div class="news-date">ë¡œë”©ì¤‘</div>
                    </div>
                    <div class="news-item">
                        <span class="news-category" style="background-color: #20c997;">ë¡œë”©ì¤‘</span>
                        <div class="news-title">ë¡œë”©ì¤‘</div>
                        <div class="news-date">ë¡œë”©ì¤‘</div>
                    </div>
                    <div class="news-item">
                        <span class="news-category" style="background-color: #845ef7;">ë¡œë”©ì¤‘</span>
                        <div class="news-title">ë¡œë”©ì¤‘</div>
                        <div class="news-date">ë¡œë”©ì¤‘</div>
                    </div>
                    <div class="news-item">
                        <span class="news-category" style="background-color: #ff922b;">ë¡œë”©ì¤‘</span>
                        <div class="news-title">ë¡œë”©ì¤‘</div>
                        <div class="news-date">ë¡œë”©ì¤‘</div>
                    </div>
                </div>
            </div>

            <!-- ì¸ê¸° ê²Œì‹œê¸€ ì¹´ë“œ -->
            <div class="content-card" id="popular-posts-card">
                <div class="card-header">ì¸ê¸° ê²Œì‹œê¸€</div>
                <div class="card-body">
                    <div class="news-item">
                        <span class="news-category" style="background-color: #339af0;">ë¡œë”©ì¤‘</span>
                        <div class="news-title">ë¡œë”©ì¤‘</div>
                        <div class="news-date">ë¡œë”©ì¤‘</div>
                    </div>
                    <div class="news-item">
                        <span class="news-category" style="background-color: #ff6b6b;">ë¡œë”©ì¤‘</span>
                        <div class="news-title">ë¡œë”©ì¤‘</div>
                        <div class="news-date">ë¡œë”©ì¤‘</div>
                    </div>
                    <div class="news-item">
                        <span class="news-category" style="background-color: #cc5de8;">ë¡œë”©ì¤‘</span>
                        <div class="news-title">ë¡œë”©ì¤‘</div>
                        <div class="news-date">ë¡œë”©ì¤‘</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì±„íŒ… ìœ„ì ¯ ê·¸ë£¹ -->
<div class="chat-widgets-group">
    <div class="chat-widgets-container">
        <!-- ì±„íŒ…ë°© ëª©ë¡ ìœ„ì ¯ -->
        <div class="chat-rooms-widget" id="chatRoomsWidget">
            <div class="chat-header">
                <div class="chat-header-title">ì±„íŒ…ë°© ëª©ë¡</div>
                <div class="chat-header-actions">
                    <button class="chat-action-button" id="closeRoomsWidget">Ã—</button>
                </div>
            </div>

            <div class="chat-content">
                <div class="chat-rooms-panel">
                    <!-- ì±„íŒ…ë°© ìƒì„± í¼ -->
                    <div class="chat-room-form">
                        <h3>ì±„íŒ…ë°© ìƒì„±</h3>
                        <div class="chat-form-group">
                            <label for="roomNameInput" class="chat-form-label">ì±„íŒ…ë°© ì´ë¦„</label>
                            <input type="text" id="roomNameInput" class="chat-form-input" placeholder="ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"/>
                        </div>

                        <div class="chat-form-checkbox">
                            <input type="checkbox" id="isSecurityInput"/>
                            <label for="isSecurityInput" class="chat-form-label">ë¹„ë°€ë°© ì„¤ì •</label>
                        </div>

                        <div class="chat-form-group" id="passwordGroup" style="display: none;">
                            <label for="passwordInput" class="chat-form-label">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="passwordInput" class="chat-form-input"
                                   placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
                        </div>

                        <button class="chat-btn chat-btn-primary" onclick="createRoom()">ì±„íŒ…ë°© ìƒì„±</button>
                    </div>

                    <!-- ì±„íŒ…ë°© ëª©ë¡ -->
                    <h3 style="margin-bottom: 12px; font-size: 15px; color: #212529;">ì±„íŒ…ë°© ëª©ë¡</h3>
                    <ul class="chat-room-list" id="roomList">
                        <!-- ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì±„íŒ… ìœ„ì ¯ -->
        <div class="chat-widget minimized" id="chatWidget">
            <!-- ì±„íŒ… ë¡œê·¸ì¸ í•„ìš” í™”ë©´ (ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš°) -->
            <div class="chat-login-required" id="chatLoginRequired">
                <div class="chat-login-icon">ğŸ”’</div>
                <div class="chat-login-message">ì±„íŒ… ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
                <button class="chat-login-button" onclick="redirectToLogin()">ë¡œê·¸ì¸í•˜ê¸°</button>
            </div>

            <!-- ì±„íŒ… ì»¨í…ì¸  (ë¡œê·¸ì¸ ëœ ê²½ìš°) -->
            <div id="chatContent" style="display: none; height: 100%; flex-direction: column;">
                <!-- í—¤ë” -->
                <div class="chat-header">
                    <div class="chat-header-room-name" id="currentRoomName">ì „ì²´ ì±„íŒ…</div>
                    <div class="chat-header-actions">
                        <!-- ì¶”ê°€: ì—¬ëŸ¬ ë°©ì„ íƒ­ìœ¼ë¡œ ë³´ì—¬ì¤„ ì»¨í…Œì´ë„ˆ -->
                        <div class="chat-header-room-tabs" id="chatTabs" style="display: flex; gap: 6px;">
                            <!-- connectToRoom() í›„ íƒ­ ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                        </div>
                        <button class="chat-action-button" id="showRoomsWidget" title="ì±„íŒ…ë°© ëª©ë¡">ğŸ </button>
                        <button class="chat-action-button" id="minimazeChat" title="ì „ì±„ ì±„íŒ…ë°©ìœ¼ë¡œ">ğŸŒ</button>
                        <button class="chat-action-button" id="closeChat" title="ë‹«ê¸°">Ã—</button>
                    </div>
                </div>

                <!-- ë©”ì¸ ì±„íŒ… íŒ¨ë„ -->
                <div class="chat-content">
                    <div class="chat-messages-panel" id="chatMessagesPanel">
                        <div class="chat-messages-container" id="messages">
                            <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>

                        <div class="chat-response-time" id="response-time">ì‘ë‹µ ì‹œê°„: -</div>

                        <div class="chat-input-container">
                            <label for="fileInput" class="chat-attach-button" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</label>
                            <input type="file" id="fileInput" class="chat-file-input"/>
                            <input type="text" id="messageInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."/>
                            <button class="chat-send-button" id="sendButton" title="ì „ì†¡">â¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì±„íŒ… í† ê¸€ ë²„íŠ¼ -->
    <div class="chat-toggle-button" id="chatToggleButton">
        ğŸ’¬
    </div>
</div>

<!-- ë¹„ë°€ë°© ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
<div class="chat-password-modal" id="passwordModal">
    <div class="chat-password-container">
        <div class="chat-password-title">ë¹„ë°€ë°© ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</div>
        <div class="chat-form-group">
            <label for="roomPasswordInput" class="chat-form-label">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="roomPasswordInput" class="chat-form-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
        </div>
        <div class="chat-password-buttons">
            <button class="chat-password-button chat-password-button-cancel" id="cancelPasswordButton">ì·¨ì†Œ</button>
            <button class="chat-password-button chat-password-button-submit" id="submitPasswordButton">í™•ì¸</button>
        </div>
    </div>
</div>
</body>
<script>
    // ================================================
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ëª¨ë“  í•¨ìˆ˜ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)
    // ================================================
    let chatWidget, chatRoomsWidget, chatToggleButton, minimizeChat, closeChat,
        closeRoomsWidget, showRoomsWidget, passwordModal, cancelPasswordButton,
        submitPasswordButton, chatLoginRequired, chatContent, messageInput,
        sendButton, fileInput, messagesContainer;

    let chatStompClient = null;
    let chatMessageSendTime = null;
    let chatCurrentRoom = null;
    let chatCurrentRoomName = "ì „ì²´ ì±„íŒ…";
    let chatSize = 10;
    let chatOldestId = null;
    let chatOldestTime = null;
    let chatLoadingInProgress = false;
    let chatSubscriptions = {};
    let tempSelectedRoom = null;
    let roomSubscriptions = {};

    // ================================================
    // í•¨ìˆ˜ ì„ ì–¸ (í˜¸ì´ìŠ¤íŒ… ì ìš©)
    // ================================================

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
    function checkChatLoginStatus() {
        const token = localStorage.getItem('jwtToken');
        if (token) {
            if (chatLoginRequired) chatLoginRequired.style.display = 'none';
            if (chatContent) chatContent.style.display = 'flex';
            if (!chatStompClient || !chatStompClient.connected) {
                connectChat();
            }
        } else {
            if (chatLoginRequired) chatLoginRequired.style.display = 'flex';
            if (chatContent) chatContent.style.display = 'none';
            if (chatRoomsWidget) chatRoomsWidget.classList.remove('visible');
            disconnectChat();
        }
    }



    function connectToRoom(room) {
        unsubscribeFromGlobalChat()
        console.log('Room ID:', room.roomId);
        const token = localStorage.getItem('jwtToken');

        // ì´ë¯¸ í•´ë‹¹ ë°©ì— ëŒ€í•œ êµ¬ë…ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        if (!chatStompClient || !chatStompClient.connected) {
            console.log('stompClientê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        // ì´ë¯¸ í•´ë‹¹ ë°©ì— ëŒ€í•œ êµ¬ë…ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        if (roomSubscriptions[room.roomId]) {
            console.log(`ì±„íŒ…ë°© ${room.roomId}ëŠ” ì´ë¯¸ êµ¬ë… ì¤‘ì…ë‹ˆë‹¤.`);
        }else {
            // ì±„íŒ…ë°© êµ¬ë… ì‹œì‘ ë° êµ¬ë… ê°ì²´ë¥¼ ì €ì¥
            let subscription = chatStompClient.subscribe(`/topic/${room.roomId}`, function (messageOutput) {
                console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', messageOutput.body);
                showRoomMessage(JSON.parse(messageOutput.body));
            }, {'Authorization': token});
            roomSubscriptions[room.roomId] = subscription; // êµ¬ë… ìƒíƒœ ì €ì¥
            console.log(`ì±„íŒ…ë°© ${room.roomId} (${room.roomName}) êµ¬ë… ì„±ê³µ!`);
        }

        chatCurrentRoom = room.roomId;
        loadChatHistoryForRoom(room.roomId);
    }


    function createRoom() {
        // localStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        // DOM ìš”ì†Œì—ì„œ ì…ë ¥ ê°’ ê°€ì ¸ì˜¤ê¸°
        const roomNameInput = document.getElementById('roomNameInput');
        const isSecurityInput = document.getElementById('isSecurityInput');
        const passwordInput = document.getElementById('passwordInput');

        const roomName = roomNameInput ? roomNameInput.value.trim() : '';
        const isSecurity = isSecurityInput ? isSecurityInput.checked : false;
        const password = passwordInput ? passwordInput.value.trim() : '';

        // ì±„íŒ…ë°© ì´ë¦„ì´ ì…ë ¥ë˜ì§€ ì•Šì€ ê²½ìš°
        if (!roomName) {
            alert('ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!');
            return;
        }

        // ì„œë²„ì— ì±„íŒ…ë°© ìƒì„± ìš”ì²­
        fetch('/room', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify({
                name: roomName,
                isSecurity: isSecurity,
                password: isSecurity ? password : ''
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.successOrFail) {
                    const room = data.data;
                    alert(`ì±„íŒ…ë°© "${room.roomName}"ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);

                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ê·¸ë£¹ ìˆ¨ê¸°ê¸°
                    if (roomNameInput) roomNameInput.value = '';
                    if (isSecurityInput) isSecurityInput.checked = false;
                    if (passwordInput) {
                        passwordInput.value = '';
                        const passwordGroup = document.getElementById('passwordGroup');
                        if (passwordGroup) passwordGroup.style.display = 'none';
                    }

                    // ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ 
                    loadRooms();
                } else {
                    alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            });
    }

    // ì±„íŒ… ì—°ê²° í•¨ìˆ˜
    function connectChat() {
        const token = localStorage.getItem('jwtToken');
        if (!token) return;
        try {
            const socket = new SockJS('/ws');
            chatStompClient = Stomp.over(socket);
            chatStompClient.debug = null;
            chatStompClient.connect({ 'Authorization': token }, function (frame) {
                console.log('ì±„íŒ… ì—°ê²° ì„±ê³µ');
                subscribeToGlobalChat();
                loadChatHistory();
            }, function (error) {
                console.error('ì±„íŒ… ì—°ê²° ì‹¤íŒ¨:', error);
                setTimeout(connectChat, 5000);
            });
        } catch (error) {
            console.error('ì±„íŒ… ì—°ê²° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
    }

    // ì±„íŒ… ì—°ê²° í•´ì œ í•¨ìˆ˜
    function disconnectChat() {
        if (chatStompClient && chatStompClient.connected) {
            // ëª¨ë“  êµ¬ë… í•´ì œ
            for (const roomId in chatSubscriptions) {
                if (chatSubscriptions[roomId]) {
                    chatSubscriptions[roomId].unsubscribe();
                    delete chatSubscriptions[roomId];
                }
            }
            chatStompClient.disconnect();
            chatStompClient = null;
            chatCurrentRoom = null;
            chatCurrentRoomName = "ì „ì²´ ì±„íŒ…";
            if (messagesContainer) messagesContainer.innerHTML = '';
        }
    }

    // íŠ¹ì • ì±„íŒ…ë°©ì˜ êµ¬ë…ì„ í•´ì œí•˜ëŠ” í•¨ìˆ˜
    function unsubscribeFromRoomChat(roomId) {
        // roomSubscriptions ê°ì²´ì— í•´ë‹¹ roomIdì˜ êµ¬ë…ì´ ìˆëŠ”ì§€ í™•ì¸
        if (roomSubscriptions[roomId]) {
            // êµ¬ë… ê°ì²´ì˜ unsubscribe() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ êµ¬ë… í•´ì œ
            roomSubscriptions[roomId].unsubscribe();
            // êµ¬ë… ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ì—ì„œ í•´ë‹¹ í•­ëª© ì‚­ì œ
            delete roomSubscriptions[roomId];
            console.log(`ì±„íŒ…ë°© ${roomId}ì˜ êµ¬ë…ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
            console.log(`ì±„íŒ…ë°© ${roomId}ì— ëŒ€í•œ êµ¬ë…ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
        }
    }


    // ì „ì²´ ì±„íŒ… êµ¬ë… í•¨ìˆ˜
    function subscribeToGlobalChat() {
        const token = localStorage.getItem('jwtToken');
        if (!chatStompClient || !chatStompClient.connected || !token) return;
        // ë§Œì•½ íŠ¹ì • ì±„íŒ…ë°©ì— í˜„ì¬ êµ¬ë…ë˜ì–´ ìˆë‹¤ë©´, í•´ë‹¹ êµ¬ë… í•´ì œ
        if (chatCurrentRoom && roomSubscriptions[chatCurrentRoom]) {
            unsubscribeFromRoomChat(chatCurrentRoom);
            // ì„ íƒì ìœ¼ë¡œ í˜„ì¬ í™œì„±í™”ëœ ì±„íŒ…ë°© ì •ë³´ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
            chatCurrentRoom = null;
        }
        if (chatSubscriptions['global']) return;
        const subscription = chatStompClient.subscribe('/topic/hi', function (messageOutput) {
            try {
                const message = JSON.parse(messageOutput.body);
                showChatMessage(message);
            } catch (error) {
                console.error('ë©”ì‹œì§€ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        }, { 'Authorization': token });
        chatSubscriptions['global'] = subscription;
        const minimazeChatButton = document.getElementById('minimazeChat');

        // ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        minimazeChatButton.addEventListener('click', function() {
            // ë²„íŠ¼ í´ë¦­ ì‹œ subscribeToGlobalChat í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
            subscribeToGlobalChat();
            loadChatHistory()
        })
    }

    // ì „ì²´ ì±„íŒ… êµ¬ë… í•´ì œ í•¨ìˆ˜
    function unsubscribeFromGlobalChat() {
        // 1. ì „ì—­ ì±„íŒ…ì— ëŒ€í•œ êµ¬ë… ê°ì²´ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        if (chatSubscriptions['global']) {
            // 2. êµ¬ë… ê°ì²´ì˜ unsubscribe() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ êµ¬ë…ì„ í•´ì œí•©ë‹ˆë‹¤.
            chatSubscriptions['global'].unsubscribe();

            // 3. êµ¬ë… í•´ì œ í›„, êµ¬ë… ê°ì²´ë¥¼ chatSubscriptionsì—ì„œ ì œê±°í•˜ì—¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            delete chatSubscriptions['global'];
            console.log('Global chat subscription has been unsubscribed.');
        } else {
            // êµ¬ë… ê°ì²´ê°€ ì—†ìœ¼ë©´ ì´ë¯¸ í•´ì œëœ ìƒíƒœì„ì„ ì•Œë¦½ë‹ˆë‹¤.
            console.log('No global chat subscription found.');
        }
    }

    // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    function sendMessage() {
        const token = localStorage.getItem('jwtToken');
        const msgInput = document.getElementById('messageInput');
        const messageContent = msgInput.value.trim();
        if (!messageContent || !chatStompClient || !chatStompClient.connected) return;
        const chatMessage = { message: messageContent };
        chatMessageSendTime = new Date();
        let destination = '/app/send/all';
        if (chatCurrentRoom) {
            destination = `/app/send/room/${chatCurrentRoom}`;
        }
        chatStompClient.send(destination, { 'Authorization': token }, JSON.stringify(chatMessage));
        msgInput.value = '';
        msgInput.focus();
    }

    function showRoomMessage(message, prepend = false) {
        console.log("Room message received:", message);
        // ê¸°ì¡´ì— ì“°ë˜ messagesContainerë¥¼ ì‚¬ìš©
          if (!messagesContainer) return;

        // í˜„ì¬ ì‚¬ìš©ì ë‹‰ë„¤ì„
        const currentUserNickname = localStorage.getItem('userNickname');

        // ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ìƒì„± (ì¼ê´€ëœ ìŠ¤íƒ€ì¼ ì ìš©)
        const messageElement = document.createElement('div');
        messageElement.className = message.username === currentUserNickname
            ? 'room-message room-message-outgoing'
            : 'room-message room-message-incoming';

        // ë©”ì‹œì§€ ë‚´ìš© ìƒì„± (í…ìŠ¤íŠ¸ ë©”ì‹œì§€)
        const messageContent = document.createElement('div');
        messageContent.className = 'room-message-content';
        if (message.message && message.message.trim() !== "") {
            messageContent.textContent = message.message;
        } else {
            // ë‚´ìš©ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë°˜í™˜
            return;
        }
        messageElement.appendChild(messageContent);

        // ë©”ì‹œì§€ ì •ë³´(ì‚¬ìš©ìëª…, ì‹œê°„) ìƒì„±
        const messageInfo = document.createElement('div');
        messageInfo.className = 'room-message-info';
        if (message.username !== currentUserNickname) {
            const usernameSpan = document.createElement('span');
            usernameSpan.className = 'room-message-username';
            usernameSpan.textContent = message.username || 'ì•Œ ìˆ˜ ì—†ìŒ';
            messageInfo.appendChild(usernameSpan);
        }
        const createdAt = new Date(message.createdAt);
        const timeSpan = document.createElement('span');
        timeSpan.className = 'room-message-time';
        timeSpan.textContent = formatChatTime(createdAt);
        messageInfo.appendChild(timeSpan);

        messageElement.appendChild(messageInfo);

        // prepend ì—¬ë¶€ì— ë”°ë¼ ë©”ì‹œì§€ ì¶”ê°€
        if (prepend) {
            messagesContainer.insertBefore(messageElement, messagesContainer.firstChild);
        } else {
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    // ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showChatMessage(message, prepend = false) {
        console.log("ë©”ì‹œì§€ ë³´ì—¬ì£¼ê¸° ì‘ë™ì¤‘~")
        if (!messagesContainer) return;
        const messageElement = document.createElement('div');
        const currentUserNickname = localStorage.getItem('userNickname');
        // ë©”ì‹œì§€ ìœ í˜•ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì„¤ì •
        messageElement.className = message.username === currentUserNickname
            ? 'chat-message chat-message-outgoing'
            : 'chat-message chat-message-incoming';

        if (message.imageUrl && message.imageUrl.trim() !== "") {
            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'chat-message-content';
            const imgElement = document.createElement('img');
            imgElement.src = message.imageUrl;
            imgElement.alt = 'ì´ë¯¸ì§€';
            imgElement.style.maxWidth = '100%';
            imgElement.style.height = 'auto';
            imgElement.style.borderRadius = '8px';
            imgElement.style.cursor = 'pointer';
            imgElement.addEventListener('click', () => window.open(message.imageUrl, '_blank'));
            messageContentDiv.appendChild(imgElement);
            messageElement.appendChild(messageContentDiv);
        } else if (message.message && message.message.trim() !== "") {
            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'chat-message-content';
            messageContentDiv.textContent = message.message;
            messageElement.appendChild(messageContentDiv);
        } else {
            return;
        }
        const messageInfo = document.createElement('div');
        messageInfo.className = 'chat-message-info';
        if (message.username !== currentUserNickname) {
            const usernameSpan = document.createElement('span');
            usernameSpan.className = 'chat-message-username';
            usernameSpan.textContent = message.username || 'ì•Œ ìˆ˜ ì—†ìŒ';
            messageInfo.appendChild(usernameSpan);
        }
        const timeSpan = document.createElement('span');
        timeSpan.className = 'chat-message-time';
        const createdAt = new Date(message.createdAt);
        timeSpan.textContent = formatChatTime(createdAt);
        messageInfo.appendChild(timeSpan);
        messageElement.appendChild(messageInfo);
        if (prepend) {
            messagesContainer.insertBefore(messageElement, messagesContainer.firstChild);
        } else {
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            if (message.username === currentUserNickname && chatMessageSendTime) {
                const responseTime = new Date(message.createdAt) - chatMessageSendTime;
                showResponseTime(responseTime);
            }
        }
    }

    // ì‘ë‹µ ì‹œê°„ í‘œì‹œ í•¨ìˆ˜
    function showResponseTime(time) {
        const responseTimeDiv = document.getElementById('response-time');
        if (responseTimeDiv) {
            responseTimeDiv.textContent = `ì‘ë‹µ ì‹œê°„: ${time}ms`;
        }
    }

    // ì±„íŒ… ë‚´ì—­ ë¡œë“œ (ì „ì²´ ì±„íŒ…)
    function loadChatHistory() {
        const token = localStorage.getItem('jwtToken');

        const chatContainer = document.getElementById('messages');

// ê¸°ì¡´ì— ë¶ˆëŸ¬ì™”ë˜ ë©”ì‹œì§€ ê¸°ë¡ì„ ì´ˆê¸°í™”(ëª¨ë‘ ì œê±°)
        chatContainer.innerHTML = '';

        if (!token) return;
        let chatId = 0;
        let lastTime = toISO8601Local(new Date());
        const url = `/chats/history?size=${chatSize}&chatId=${chatId}&lastTime=${encodeURIComponent(lastTime)}`;
        console.log("lastTime:", lastTime);
        console.log("url:", url);

        fetch(url, {
            method: 'GET',
            headers: { 'Authorization': token }
        })
            .then(response => response.json())
            .then(data => {
                console.log("Response data:", data);
                // ìˆ˜ì •: ì‹¤ì œ ë©”ì‹œì§€ ë°°ì—´ì€ chatsResponses[1]ì— ë“¤ì–´ìˆìŒ
                if (data && data.data && Array.isArray(data.data.chatsResponses) && data.data.chatsResponses.length > 1) {
                    const messages = data.data.chatsResponses[1];
                    // messages ë°°ì—´ í™•ì¸
                    console.log("Extracted messages:", messages);
                    messages.reverse();
                    messages.forEach(message => {
                        showChatMessage(message, false);
                    });
                    if (messages.length > 0) {
                        chatOldestId = messages[0].chatsId;
                        chatOldestTime = messages[0].createdAt;
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            })
            .catch(error => console.error('ì±„íŒ… ë‚´ì—­ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
    }


    // ì±„íŒ…ë°© ë‚´ì—­ ë¡œë“œ
    function loadChatHistoryForRoom(roomId) {
        const token = localStorage.getItem('jwtToken');
        if (!token || !roomId) return;
        let chatId = 0;
        let lastTime = toISO8601Local(new Date());
        const url = `/chats/${roomId}?size=${chatSize}&chatId=${chatId}&lastTime=${encodeURIComponent(lastTime)}`;
        fetch(url, {
            method: 'GET',
            headers: { 'Authorization': token }
        })
            .then(response => response.json())
            .then(data => {
                if (data && data.data && Array.isArray(data.data.chatResponses)) {
                    // ì‹¤ì œ ë©”ì‹œì§€ ë°°ì—´ê°€ ë‘ë²ˆì§¸ ìš”ì†Œì— ìœ„ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                    let messages = data.data.chatResponses;
                    if (messages.length > 1 && Array.isArray(messages[1])) {
                        messages = messages[1];
                    }
                    messages.reverse();
                    messagesContainer.innerHTML = '';
                    messages.forEach(message => {
                        showRoomMessage(message, false);
                    });
                    if (messages.length > 0) {
                        chatOldestId = messages[0].chatsId;
                        chatOldestTime = messages[0].createdAt;
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            })
            .catch(error => console.error('ì±„íŒ…ë°© ë‚´ì—­ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
    }




    document.addEventListener('DOMContentLoaded', () => {
        const showRoomsWidget = document.getElementById('showRoomsWidget');
        const chatRoomsWidget = document.getElementById('chatRoomsWidget');

        if (showRoomsWidget && chatRoomsWidget) {
            showRoomsWidget.addEventListener('click', () => {
                chatRoomsWidget.classList.add('visible');
                loadRooms();
            });
        }
    });

    function loadRooms() {
        const token = localStorage.getItem('jwtToken');
        if (!token) return;

        fetch('/room', {
            method: 'GET',
            headers: { 'Authorization': token }
        })
            .then(response => response.json())
            .then(data => {
                console.log('room response:', data);
                const roomList = document.getElementById('roomList');
                roomList.innerHTML = '';

                let rooms = [];
                if (data.successOrFail && data.data) {
                    // ë§Œì•½ roomResponsesê°€ [typeInfo, ì‹¤ì œ ë°°ì—´] í˜•íƒœë¼ë©´
                    if (Array.isArray(data.data.roomResponses)) {
                        if (data.data.roomResponses.length > 1 && Array.isArray(data.data.roomResponses[1])) {
                            rooms = data.data.roomResponses[1];
                        } else {
                            rooms = data.data.roomResponses;
                        }
                    }
                }

                if (rooms && Array.isArray(rooms)) {
                    rooms.forEach(room => {
                        const roomElement = document.createElement('li');
                        roomElement.textContent = `${room.roomName} (${room.isSecurity ? 'ğŸ”’' : 'ğŸ”“'})`;
                        roomElement.onclick = () => connectToRoom(room);
                        roomList.appendChild(roomElement);
                    });
                }
            })
            .catch(error => console.error('ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
    }


    // ì´ì „ ë©”ì‹œì§€ ë¡œë“œ
    function loadOlderMessages() {
        if (chatLoadingInProgress) return;
        chatLoadingInProgress = true;
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            chatLoadingInProgress = false;
            return;
        }
        if (!chatOldestId || !chatOldestTime) {
            chatLoadingInProgress = false;
            return;
        }
        let url;
        if (chatCurrentRoom) {
            url = `/chats/${chatCurrentRoom}?size=${chatSize}&chatId=${chatOldestId}&lastTime=${encodeURIComponent(chatOldestTime)}`;
        } else {
            url = `/chats/history?size=${chatSize}&chatId=${chatOldestId}&lastTime=${encodeURIComponent(chatOldestTime)}`;
        }
        const previousScrollHeight = messagesContainer.scrollHeight;
        fetch(url, {
            method: 'GET',
            headers: { 'Authorization': token }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (HTTP ${response.status})`);
                }
                return response.json();
            })
            .then(data => {
                const messages = data && data.data ? (chatCurrentRoom ? data.data.chatResponses : data.data.chatsResponses) : [];
                if (!Array.isArray(messages) || messages.length === 0) {
                    return;
                }
                messages.forEach(message => {
                    showChatMessage(message, true);
                });
                if (messages.length > 0) {
                    chatOldestId = messages[messages.length - 1].chatsId;
                    chatOldestTime = messages[messages.length - 1].createdAt;
                }
                const newScrollHeight = messagesContainer.scrollHeight;
                messagesContainer.scrollTop = newScrollHeight - previousScrollHeight;
            })
            .catch(error => console.error('ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error))
            .finally(() => {
                chatLoadingInProgress = false;
            });
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜
    function handleFileUpload() {
        const token = localStorage.getItem('jwtToken');
        const file = fileInput.files[0];
        if (!file) return;
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
            fileInput.value = '';
            return;
        }
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            fileInput.value = '';
            return;
        }
        const filename = encodeURIComponent(file.name);
        fetch(`/images/hi/bye?filename=${filename}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.successOrFail && data.data) {
                    const presignedUrl = data.data;
                    return fetch(presignedUrl, {
                        method: 'PUT',
                        body: file,
                        headers: { 'Content-Type': file.type }
                    });
                } else {
                    throw new Error('URL ìƒì„± ì‹¤íŒ¨');
                }
            })
            .then(response => {
                if (response.ok) {
                    const fileUrl = response.url.split('?')[0];
                    const message = { imageUrl: fileUrl, message: "" };
                    sendImageMessage(message);
                } else {
                    throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            })
            .catch(error => {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                fileInput.value = '';
            });
    }

    // ì´ë¯¸ì§€ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    function sendImageMessage(message) {
        const token = localStorage.getItem('jwtToken');
        if (!chatStompClient || !chatStompClient.connected) {
            alert('ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }
        let destination = '/app/send/all';
        if (chatCurrentRoom) {
            destination = `/app/send/room/${chatCurrentRoom}`;
        }
        chatStompClient.send(destination, { 'Authorization': token }, JSON.stringify(message));
    }

    // ì‹œê°„ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜ (ISO 8601)
    function toISO8601Local(date) {
        let timezoneOffset = -date.getTimezoneOffset();
        let timezoneSign = timezoneOffset >= 0 ? '+' : '-';
        let timezoneHours = String(Math.floor(Math.abs(timezoneOffset) / 60)).padStart(2, '0');
        let timezoneMinutes = String(Math.abs(timezoneOffset) % 60).padStart(2, '0');
        let localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
        let isoString = localDate.toISOString().replace('Z', `${timezoneSign}${timezoneHours}:${timezoneMinutes}`);
        return isoString;
    }

    // ì±„íŒ… ì‹œê°„ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
    function formatChatTime(date) {
        return date.toLocaleString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    }

    // ================================================
    // DOMContentLoaded ì´ë²¤íŠ¸: DOM ìš”ì†Œ ë°”ì¸ë”© ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    // ================================================
    document.addEventListener('DOMContentLoaded', function() {
        chatWidget = document.getElementById('chatWidget');
        chatRoomsWidget = document.getElementById('chatRoomsWidget');
        chatToggleButton = document.getElementById('chatToggleButton');
        minimizeChat = document.getElementById('minimizeChat');
        closeChat = document.getElementById('closeChat');
        closeRoomsWidget = document.getElementById('closeRoomsWidget');
        showRoomsWidget = document.getElementById('showRoomsWidget');
        passwordModal = document.getElementById('passwordModal');
        cancelPasswordButton = document.getElementById('cancelPasswordButton');
        submitPasswordButton = document.getElementById('submitPasswordButton');
        chatLoginRequired = document.getElementById('chatLoginRequired');
        chatContent = document.getElementById('chatContent');
        messageInput = document.getElementById('messageInput');
        sendButton = document.getElementById('sendButton');
        fileInput = document.getElementById('fileInput');
        messagesContainer = document.getElementById('messages');

        if (chatToggleButton) {
            chatToggleButton.addEventListener('click', function() {
                chatWidget.classList.toggle('minimized');
                checkChatLoginStatus();
            });
        }
        if (sendButton) {
            sendButton.addEventListener('click', sendMessage);
        }
        if (messageInput) {
            messageInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') sendMessage();
            });
        }
        if (fileInput) {
            fileInput.addEventListener('change', handleFileUpload);
        }
        if (messagesContainer) {
            messagesContainer.addEventListener('scroll', function() {
                if (this.scrollTop < 50 && !chatLoadingInProgress) {
                    loadOlderMessages();
                }
            });
        }
        if (cancelPasswordButton) {
            cancelPasswordButton.addEventListener('click', function() {
                passwordModal.classList.remove('visible');
                tempSelectedRoom = null;
            });
        }
        if (submitPasswordButton) {
            submitPasswordButton.addEventListener('click', function() {
                const password = document.getElementById('roomPasswordInput').value.trim();
                if (password && tempSelectedRoom) {
                    verifyRoomPassword(tempSelectedRoom, password);
                } else {
                    alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            });
        }
        if (closeChat) {
            closeChat.addEventListener('click', function() {
                // 1) chatWidgetì„ ì•„ì˜ˆ ë‹«ê³  ì‹¶ë‹¤ë©´ minimized í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•´ì„œ ìˆ¨ê¸´ë‹¤
                chatWidget.classList.add('minimized');

                // 2) ë˜ëŠ” DOMì—ì„œ ì™„ì „íˆ ì œê±°í•˜ê³  ì‹¶ë‹¤ë©´
                // chatWidget.remove();
            });
        }
        if (closeRoomsWidget) {
            closeRoomsWidget.addEventListener('click', function() {
                // 1) chatWidgetì„ ì•„ì˜ˆ ë‹«ê³  ì‹¶ë‹¤ë©´ minimized í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•´ì„œ ìˆ¨ê¸´ë‹¤
                chatRoomsWidget.classList.remove('visible');

                // 2) ë˜ëŠ” DOMì—ì„œ ì™„ì „íˆ ì œê±°í•˜ê³  ì‹¶ë‹¤ë©´
                // chatWidget.remove();
            });
        }
        const isSecurityInput = document.getElementById('isSecurityInput');
        if (isSecurityInput) {
            isSecurityInput.addEventListener('change', function() {
                const passwordGroup = document.getElementById('passwordGroup');
                if (this.checked) {
                    passwordGroup.style.display = 'block';
                } else {
                    passwordGroup.style.display = 'none';
                    document.getElementById('passwordInput').value = '';
                }
            });
        }
        // ê¸°íƒ€ DOM ìš”ì†Œì— ëŒ€í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡...

        checkChatLoginStatus();
    });


    async function fetchRecommendedPosts() {
        try {
            const response = await fetch(`/posts/hi/popular`);
            if (!response.ok) {
                throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (HTTP ${response.status})`);
            }

            const responseData = await response.json();
            console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", responseData); // âœ… ì‘ë‹µ êµ¬ì¡° í™•ì¸

            // âœ… postListì—ì„œ ì‹¤ì œ ë°°ì—´ë§Œ ì¶”ì¶œ
            const posts = responseData.data.postList[1];

            if (!Array.isArray(posts)) {
                throw new Error("postListì˜ ë°ì´í„° í˜•ì‹ì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }

            renderRecommendedPosts(posts);

        } catch (error) {
            console.error("ì¸ê¸° ê²Œì‹œê¸€ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
    }

    async function fetchLatestNews() {
        try {
            const response = await fetch("/posts/hi/recent"); // âœ… ìµœì‹  ì†Œì‹ ìš”ì²­
            if (!response.ok) {
                throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (HTTP ${response.status})`);
            }

            const responseData = await response.json();
            console.log("ìµœì‹  ì†Œì‹ ë°ì´í„°:", responseData); // âœ… ì‘ë‹µ êµ¬ì¡° í™•ì¸

            const newsList = responseData.data.postResponses[1];
            ; // âœ… ìµœì‹  ì†Œì‹ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ

            if (!Array.isArray(newsList)) {
                throw new Error("newsListì˜ ë°ì´í„° í˜•ì‹ì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }

            renderLatestNews(newsList); // âœ… ìµœì‹  ì†Œì‹ UI ì—…ë°ì´íŠ¸
        } catch (error) {
            console.error("ìµœì‹  ì†Œì‹ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
    }

    function renderLatestNews(newsList) {
        const cardBody = document.querySelector("#latest-news-card .card-body");
        cardBody.innerHTML = ""; // âœ… ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        console.log(newsList)
        newsList.forEach(news => {
            const newsItem = document.createElement("div");
            newsItem.classList.add("news-item");

            // âœ… `data-post-id` ì†ì„± ì¶”ê°€ (ê²Œì‹œê¸€ ID ì €ì¥)
            newsItem.innerHTML = `
            <span class="news-category" style="background-color: ${getCategoryColor(news.categoryName)};">
                ${news.categoryName}
            </span>
            <div class="news-title" data-post-id="${news.postId}">
                ${news.title}
            </div>
            <div class="news-date">${formatTimeAgo(news.createdAt)}</div>
        `;

            cardBody.appendChild(newsItem); // âœ… ë™ì ìœ¼ë¡œ ì¶”ê°€
        });
    }

    // âœ… ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ ì ìš© (ë¶€ëª¨ ìš”ì†Œì—ì„œ í´ë¦­ ì´ë²¤íŠ¸ ê°ì§€)
    document.querySelector("#latest-news-card .card-body").addEventListener("click", function(event) {
        const clickedTitle = event.target.closest(".news-title"); // í´ë¦­ëœ ìš”ì†Œê°€ `.news-title`ì¸ì§€ í™•ì¸

        if (clickedTitle) {
            const postId = clickedTitle.getAttribute("data-post-id");
            localStorage.setItem("postId", postId); // âœ… postId ì €ì¥
            window.location.href = "/boardeatail/hi/game"; // âœ… í˜ì´ì§€ ì´ë™
        }
    });

    // âœ… ì¸ê¸° ê²Œì‹œê¸€ì„ ë™ì ìœ¼ë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
    function renderRecommendedPosts(posts) {
        const cardBody = document.querySelector("#popular-posts-card .card-body");
        cardBody.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        posts.forEach(post => {
            const newsItem = document.createElement("div");
            newsItem.classList.add("news-item");

            // âœ… `id`ë¥¼ ì—†ì• ê³  `data-post-id` ì†ì„±ì„ ì‚¬ìš©í•´ ë°ì´í„°ë¥¼ ì €ì¥
            newsItem.innerHTML = `
            <span class="news-category" style="background-color: ${getCategoryColor(post.categoryName)};">
                ${post.categoryName}
            </span>
            <div class="news-title" data-post-id="${post.id}">
                ${post.title}
            </div>
            <div class="news-date">ì¡°íšŒ ${post.viewCount.toLocaleString()}</div>
        `;

            cardBody.appendChild(newsItem);
        });
    }

    document.querySelector("#popular-posts-card .card-body").addEventListener("click", function(event) {
        const clickedTitle = event.target.closest(".news-title"); // í´ë¦­í•œ ìš”ì†Œê°€ .news-titleì¸ì§€ í™•ì¸

        if (clickedTitle) {
            const cardId = clickedTitle.getAttribute("data-post-id"); // âœ… `data-post-id`ì—ì„œ ID ê°€ì ¸ì˜¤ê¸°
            localStorage.setItem("postId", cardId); // postId ì €ì¥
            window.location.href = "/boardeatail/hi/game"; // í˜ì´ì§€ ì´ë™
        }
    });
    // âœ… ì´ë²¤íŠ¸ ìœ„ì„: `.card-body`ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€



    function getCategoryColor(categoryName) {
        return `#${Math.floor(Math.random() * 16777215).toString(16)}`;
    }

    function login() {
        // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        // JSON ë°ì´í„° ìƒì„±
        const loginData = {
            loginId: username,
            password: password
        };

        // ì„œë²„ë¡œ POST ìš”ì²­ ë³´ë‚´ê¸°
        fetch("/auth/hi/users/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"  // JSON ë°ì´í„°ì„ì„ ëª…ì‹œ
            },
            body: JSON.stringify(loginData)  // JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
        })
            .then(response => {
            // ì‘ë‹µ ìƒíƒœ í™•ì¸
            if (!response.ok) {
                // ì‘ë‹µì´ ì‹¤íŒ¨ì¼ ê²½ìš°, JSON í˜•íƒœë¡œ íŒŒì‹±í•˜ì—¬ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                return response.json().then(errorData => {
                    if (errorData.message) {
                        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + errorData.message);
                    } else {
                        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
                    }
                    throw new Error(errorData.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
                });
            }
            // ì‘ë‹µì´ ì„±ê³µì ì¼ ê²½ìš° JSON íŒŒì‹±
            return response.json();
        })
            .then(data => {
                if (data.successOrFail && data.data && data.data.token) {
                    const token = data.data.token; // âœ… JWT í† í° ì¶”ì¶œ
                    localStorage.setItem("jwtToken", token); // âœ… JWT í† í° ì €ì¥
                    alert("ë¡œê·¸ì¸ ì„±ê³µ!");
                    checkLoginStatus() // âœ… í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™
                } else {
                    throw new Error("í† í°ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            })
            .catch(error => console.error("Error:", error));

    }

    function checkLoginStatus() {
    const jwtToken = localStorage.getItem("jwtToken");  // ê¸°ì¡´ JWT í† í° í™•ì¸
    const kakaoToken = localStorage.getItem("kakaoToken");  // ì¹´ì¹´ì˜¤ í† í° í™•ì¸

    const nonLoggedInContent = document.getElementById("non-logged-in-content");
    const loggedInContent = document.getElementById("logged-in-content");

    // âœ… ì¹´ì¹´ì˜¤ í† í°ì´ ìˆëŠ” ê²½ìš°, ì„œë²„ë¡œ ë¡œê·¸ì¸ ìš”ì²­
    if (kakaoToken && !jwtToken) {
        fetch("/auth/hi/kakao/login", {  // ì„œë²„ì˜ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                kakaoToken: kakaoToken
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‘ë‹µ:", data);
            if (data.successOrFail) {
                const jwtToken = data.data?.token;
                if (jwtToken) {
                    // âœ… ì„œë²„ë¡œë¶€í„° ìƒˆë¡œìš´ JWT í† í°ì„ ë°›ì•„ ì €ì¥
                    localStorage.setItem("jwtToken", jwtToken);

                    // âœ… ë¡œê·¸ì¸ ìƒíƒœë¥¼ ë°”ë¡œ ì—…ë°ì´íŠ¸
                    updateLoginStatus(jwtToken);
                } else {
                    console.error("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨: JWT í† í° ì—†ìŒ");
                }
            } else {
                console.error("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨: ", data.message);
            }
        })
        .catch(error => {
            console.error("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ìš”ì²­ ì˜¤ë¥˜: ", error);
        });
        return;  // ë¹„ë™ê¸° ì²˜ë¦¬ í›„ ë‹¤ì‹œ ê²€ì‚¬í•˜ì§€ ì•Šë„ë¡ ë¦¬í„´
    }

    // âœ… ê¸°ì¡´ JWT í† í°ì´ ìˆëŠ” ê²½ìš°, ë°”ë¡œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    updateLoginStatus(jwtToken);
}
// âœ… ë¡œê·¸ì¸ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ë¡œ ë¶„ë¦¬
function updateLoginStatus(token) {
    const nonLoggedInContent = document.getElementById("non-logged-in-content");
    const loggedInContent = document.getElementById("logged-in-content");

fetchUserInfo();  // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    if (token) {
        loggedInContent.style.display = "block";
        nonLoggedInContent.style.display = "none";
    } else {
        loggedInContent.style.display = "none";
        nonLoggedInContent.style.display = "block";
    }
}

    function fetchUserInfo() {
        const token = localStorage.getItem("jwtToken");

        if (!token) {
            console.error("JWT í† í° ì—†ìŒ. ë¡œê·¸ì¸ í•„ìš”.");
            return;
        }

        fetch("/users", {  // âœ… GET ìš”ì²­
            method: "GET",
            headers: {
                "Authorization": `${token}` // âœ… ì„œë²„ì— JWT í† í° ì „ë‹¬
            }
        })
            .then(response => {
                if (!response.ok) {
                    localStorage.removeItem("jwtToken");
                    throw new Error("ìœ ì € ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                }
                return response.json();
            })
            .then(response => {
                const rawDate = response.data.createdAt || null;
                const formattedDate = rawDate ? formatDateTime(rawDate) : "ì •ë³´ ì—†ìŒ";

                // âœ… ë°›ì€ ë°ì´í„°ë¥¼ UIì— ì ìš©
                document.getElementById("user-nickname").innerText = response.data.nickname || "ì•Œ ìˆ˜ ì—†ìŒ";
                document.getElementById("join-date").innerText = formattedDate;
            })
            .catch(error => console.error("Error:", error));
    }

    // âœ… ë‚ ì§œ ë³€í™˜ í•¨ìˆ˜ (ISO 8601 â†’ YYYY-MM-DD HH:MM:SS)
    function formatDateTime(isoString) {
        const date = new Date(isoString);

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // âœ… ì›” (1ì›” = 0ì´ë¯€ë¡œ +1)
        const day = String(date.getDate()).padStart(2, '0'); // âœ… ì¼
        const hours = String(date.getHours()).padStart(2, '0'); // âœ… ì‹œ
        const minutes = String(date.getMinutes()).padStart(2, '0'); // âœ… ë¶„
        const seconds = String(date.getSeconds()).padStart(2, '0'); // âœ… ì´ˆ

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function formatTimeAgo(isoString) {
        const createdAt = new Date(isoString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - createdAt) / 1000); // âœ… í˜„ì¬ ì‹œê°„ê³¼ì˜ ì°¨ì´ (ì´ˆ ë‹¨ìœ„)

        if (diffInSeconds < 60) {
            return `${diffInSeconds}ì´ˆ ì „`; // âœ… 1ë¶„ ë¯¸ë§Œ
        } else if (diffInSeconds < 3600) {
            return `${Math.floor(diffInSeconds / 60)}ë¶„ ì „`; // âœ… 1ì‹œê°„ ë¯¸ë§Œ
        } else if (diffInSeconds < 86400) {
            return `${Math.floor(diffInSeconds / 3600)}ì‹œê°„ ì „`; // âœ… 24ì‹œê°„ ë¯¸ë§Œ
        } else {
            return `${Math.floor(diffInSeconds / 86400)}ì¼ ì „`; // âœ… í•˜ë£¨ ì´ìƒ
        }
    }
    function logout() {
        localStorage.removeItem("jwtToken");  // âœ… JWT í† í° ì‚­ì œ
        localStorage.removeItem("kakaoToken") // ì¹´ì¹´ì˜¤ í† í°ì‚­ì œ
        alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        checkLoginStatus();  // âœ… ìƒíƒœ ì¦‰ì‹œ ë°˜ì˜
    }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    window.onload = function () {
        checkLoginStatus(); // âœ… ê¸°ì¡´ ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ í•¨ìˆ˜ ì‹¤í–‰
        fetchRecommendedPosts(); // âœ… ì¸ê¸° ê²Œì‹œê¸€ ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰
        fetchLatestNews(); // âœ… ìµœì‹  ì†Œì‹ ê°€ì ¸ì˜¤ê¸°
    };

    // âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ê°ì§€ (MutationObserver ëŒ€ì²´)
    window.addEventListener("storage", (event) => {
        if (event.key === "jwtToken") {
            checkLoginStatus();  // âœ… í† í° ë³€ê²½ ê°ì§€ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
        }
    });
</script>


</script>
</html>